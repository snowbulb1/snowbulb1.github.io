<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tank.io - Battle Arena</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@500;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            overflow: hidden;
            font-family: 'Rajdhani', sans-serif;
            background: #0a0e1a;
            color: #fff;
        }
        
        #gameCanvas {
            display: block;
            background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
            cursor: crosshair;
        }
        
        #ui {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        #stats {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(15, 20, 25, 0.85);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 12px;
            border: 2px solid rgba(0, 255, 157, 0.3);
            box-shadow: 0 8px 32px rgba(0, 255, 157, 0.15);
        }
        
        #stats h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            color: #00ff9d;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 8px;
            text-shadow: 0 0 10px rgba(0, 255, 157, 0.5);
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            font-size: 16px;
            margin: 5px 0;
            font-weight: 600;
        }
        
        .high-score {
            color: #ffd700 !important;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.6) !important;
        }
        
        .stat-label {
            color: #8892a6;
            margin-right: 20px;
        }
        
        .stat-value {
            color: #00ff9d;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 8px rgba(0, 255, 157, 0.4);
        }
        
        #health-bar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            height: 40px;
            background: rgba(15, 20, 25, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 2px solid rgba(0, 255, 157, 0.3);
            overflow: visible;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        #health-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff9d 0%, #00d4aa 100%);
            transition: width 0.3s ease;
            box-shadow: 0 0 20px rgba(0, 255, 157, 0.6);
            border-radius: 18px;
        }
        
        #health-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 16px;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
        }

        #kill-feed {
            position: absolute;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            pointer-events: none;
        }

        .kill-notification {
            font-family: 'Orbitron', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: #00ff9d;
            text-shadow: 0 0 10px rgba(0, 255, 157, 0.8);
            animation: killFade 2s ease-out forwards;
        }

        @keyframes killFade {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            70% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        #bomb-counter {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(15, 20, 25, 0.85);
            backdrop-filter: blur(10px);
            padding: 12px 18px;
            border-radius: 12px;
            border: 2px solid rgba(255, 193, 7, 0.3);
            box-shadow: 0 8px 32px rgba(255, 193, 7, 0.15);
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: #ffc107;
            text-shadow: 0 0 8px rgba(255, 193, 7, 0.4);
        }
        
        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(15, 20, 25, 0.85);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 12px;
            border: 2px solid rgba(0, 255, 157, 0.3);
            box-shadow: 0 8px 32px rgba(0, 255, 157, 0.15);
            font-size: 14px;
            line-height: 1.8;
        }
        
        #controls h3 {
            font-family: 'Orbitron', sans-serif;
            color: #00ff9d;
            margin-bottom: 8px;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .control-item {
            color: #8892a6;
        }
        
        .control-key {
            display: inline-block;
            background: rgba(0, 255, 157, 0.15);
            color: #00ff9d;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .upgrades-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .upgrade-item {
            background: rgba(0, 255, 157, 0.08);
            padding: 12px;
            border-radius: 8px;
            border: 2px solid rgba(0, 255, 157, 0.2);
            transition: all 0.3s ease;
        }
        
        .upgrade-item:hover {
            border-color: rgba(0, 255, 157, 0.5);
            background: rgba(0, 255, 157, 0.12);
        }
        
        .upgrade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .upgrade-name {
            font-family: 'Orbitron', sans-serif;
            color: #00ff9d;
            font-size: 14px;
            font-weight: 700;
        }
        
        .upgrade-level {
            color: #8892a6;
            font-size: 12px;
        }
        
        .upgrade-description {
            color: #8892a6;
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        .upgrade-btn {
            width: 100%;
            background: linear-gradient(135deg, #00ff9d 0%, #00d4aa 100%);
            color: #0a0e1a;
            border: none;
            padding: 8px;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            pointer-events: all;
        }
        
        .upgrade-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 157, 0.4);
        }
        
        .upgrade-btn:active {
            transform: translateY(0);
        }
        
        .upgrade-btn:disabled {
            background: rgba(136, 146, 166, 0.3);
            color: #8892a6;
            cursor: not-allowed;
            transform: none;
        }
        
        #pause-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 26, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            overflow-y: auto;
        }
        
        #pause-overlay.show {
            display: flex;
        }
        
        .pause-content {
            text-align: center;
            pointer-events: all;
            max-width: 800px;
            padding: 40px;
        }
        
        .pause-content h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 64px;
            color: #00ff9d;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 8px;
            text-shadow: 0 0 30px rgba(0, 255, 157, 0.8);
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .pause-text {
            color: #8892a6;
            font-size: 18px;
            margin-bottom: 30px;
        }
        
        .pause-upgrades {
            background: rgba(15, 20, 25, 0.85);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 12px;
            border: 2px solid rgba(0, 255, 157, 0.3);
            box-shadow: 0 8px 32px rgba(0, 255, 157, 0.15);
            margin-top: 20px;
        }
        
        .pause-upgrades h3 {
            font-family: 'Orbitron', sans-serif;
            color: #00ff9d;
            margin-bottom: 20px;
            font-size: 24px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .upgrades-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .upgrade-section {
            background: rgba(15, 20, 25, 0.85);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid rgba(0, 255, 157, 0.3);
            box-shadow: 0 8px 32px rgba(0, 255, 157, 0.15);
        }
        
        .upgrade-section h4 {
            font-family: 'Orbitron', sans-serif;
            color: #00ff9d;
            margin-bottom: 15px;
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
        }
        
        .special-upgrade-section {
            border-color: rgba(255, 215, 0, 0.5);
        }
        
        .special-upgrade-section h4 {
            color: #ffd700;
        }
        
        .special-upgrade-item {
            background: rgba(255, 215, 0, 0.08);
            padding: 15px;
            border-radius: 8px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .special-upgrade-item:hover {
            border-color: rgba(255, 215, 0, 0.6);
            background: rgba(255, 215, 0, 0.15);
        }
        
        .special-upgrade-name {
            font-family: 'Orbitron', sans-serif;
            color: #ffd700;
            font-size: 14px;
            font-weight: 700;
        }
        
        .special-upgrade-btn {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #0a0e1a;
        }
        
        .special-upgrade-btn:hover {
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
        }
        
        #game-over {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: rgba(15, 20, 25, 0.95);
            backdrop-filter: blur(20px);
            padding: 40px 60px;
            border-radius: 20px;
            border: 3px solid #00ff9d;
            text-align: center;
            pointer-events: none;
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 20px 60px rgba(0, 255, 157, 0.3);
            z-index: 200;
        }
        
        #game-over.show {
            transform: translate(-50%, -50%) scale(1);
            pointer-events: all;
        }
        
        #game-over h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 48px;
            color: #00ff9d;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 5px;
            text-shadow: 0 0 20px rgba(0, 255, 157, 0.8);
        }
        
        #final-score {
            font-size: 24px;
            margin-bottom: 30px;
            color: #8892a6;
        }
        
        #restart-btn {
            background: linear-gradient(135deg, #00ff9d 0%, #00d4aa 100%);
            color: #0a0e1a;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            border-radius: 10px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 24px rgba(0, 255, 157, 0.4);
            pointer-events: all;
        }
        
        #restart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(0, 255, 157, 0.6);
        }
        
        #restart-btn:active {
            transform: translateY(0);
        }

        #screen-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.1s ease;
        }

        #level-complete-banner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: rgba(0, 255, 157, 0.95);
            backdrop-filter: blur(20px);
            padding: 30px 60px;
            border-radius: 20px;
            border: 3px solid #00ff9d;
            text-align: center;
            pointer-events: none;
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 20px 60px rgba(0, 255, 157, 0.6);
            z-index: 50;
        }

        #level-complete-banner.show {
            transform: translate(-50%, -50%) scale(1);
        }

        #level-complete-banner h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 48px;
            color: #0a0e1a;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 5px;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        #boss-health-bar {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            background: rgba(15, 20, 25, 0.85);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            border: 2px solid rgba(138, 43, 226, 0.5);
            box-shadow: 0 8px 32px rgba(138, 43, 226, 0.3);
            display: none;
        }

        #boss-health-bar.show {
            display: block;
        }

        .boss-name {
            font-family: 'Orbitron', sans-serif;
            color: #8a2be2;
            font-size: 16px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(138, 43, 226, 0.6);
        }

        .boss-bar-container {
            width: 100%;
            height: 20px;
            background: rgba(15, 20, 25, 0.85);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid rgba(138, 43, 226, 0.3);
            position: relative;
        }

        #boss-health-fill {
            height: 100%;
            background: linear-gradient(90deg, #8a2be2 0%, #9370db 100%);
            transition: width 0.3s ease;
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.6);
        }

        .boss-health-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 12px;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <div id="screen-effect"></div>

    <div id="ui">
        <div id="stats">
            <h2>Tank.io</h2>
            <div class="stat-row">
                <span class="stat-label">Score:</span>
                <span class="stat-value" id="score">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">High Score:</span>
                <span class="stat-value high-score" id="highScore">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Level:</span>
                <span class="stat-value" id="level">1</span>
            </div>
        </div>

        <div id="boss-health-bar">
            <div class="boss-name">BOSS</div>
            <div class="boss-bar-container">
                <div id="boss-health-fill"></div>
                <div class="boss-health-text" id="boss-health-text">1000 / 1000</div>
            </div>
        </div>
        
        <div id="controls">
            <h3>Controls</h3>
            <div class="control-item"><span class="control-key">WASD</span> Move</div>
            <div class="control-item"><span class="control-key">Left Click</span> Shoot</div>
            <div class="control-item"><span class="control-key">Right Click</span> Auto-Shoot</div>
            <div class="control-item"><span class="control-key">E</span> Use Bomb</div>
            <div class="control-item"><span class="control-key">ESC</span> Pause</div>
        </div>
        
        <div id="health-bar">
            <div id="health-fill"></div>
            <div id="health-text">100 / 100</div>
        </div>

        <div id="kill-feed"></div>

        <div id="bomb-counter">Bombs: 0/2</div>

        <div id="level-complete-banner">
            <h1>LEVEL COMPLETE</h1>
        </div>
        
        <div id="pause-overlay">
            <div class="pause-content">
                <h1>PAUSED</h1>
                <p class="pause-text">Press ESC to resume</p>
                
                <div class="pause-upgrades">
                    <h3>Upgrades</h3>
                    <div class="upgrades-container">
                        <div class="upgrade-section">
                            <h4>Standard Upgrades</h4>
                            <div class="upgrades-grid">
                                <div class="upgrade-item">
                                    <div class="upgrade-header">
                                        <span class="upgrade-name">Fire Rate</span>
                                        <span class="upgrade-level" id="fireRateLevel">Lv 0</span>
                                    </div>
                                    <div class="upgrade-description">Shoot faster</div>
                                    <button class="upgrade-btn" id="fireRateBtn" onclick="purchaseUpgrade('fireRate')">
                                        Buy (50 pts)
                                    </button>
                                </div>
                                
                                <div class="upgrade-item">
                                    <div class="upgrade-header">
                                        <span class="upgrade-name">Damage</span>
                                        <span class="upgrade-level" id="damageLevel">Lv 0</span>
                                    </div>
                                    <div class="upgrade-description">Deal more damage</div>
                                    <button class="upgrade-btn" id="damageBtn" onclick="purchaseUpgrade('damage')">
                                        Buy (50 pts)
                                    </button>
                                </div>
                                
                                <div class="upgrade-item">
                                    <div class="upgrade-header">
                                        <span class="upgrade-name">Max Health</span>
                                        <span class="upgrade-level" id="healthLevel">Lv 0</span>
                                    </div>
                                    <div class="upgrade-description">Increase max HP</div>
                                    <button class="upgrade-btn" id="healthBtn" onclick="purchaseUpgrade('health')">
                                        Buy (75 pts)
                                    </button>
                                </div>
                                
                                <div class="upgrade-item">
                                    <div class="upgrade-header">
                                        <span class="upgrade-name">Speed</span>
                                        <span class="upgrade-level" id="speedLevel">Lv 0</span>
                                    </div>
                                    <div class="upgrade-description">Move faster</div>
                                    <button class="upgrade-btn" id="speedBtn" onclick="purchaseUpgrade('speed')">
                                        Buy (40 pts)
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="upgrade-section special-upgrade-section">
                            <h4>Special Upgrades</h4>
                            <div class="special-upgrade-item">
                                <div class="upgrade-header">
                                    <span class="special-upgrade-name">Hire a Recruit</span>
                                    <span class="upgrade-level" id="recruitLevel">0 / 6</span>
                                </div>
                                <div class="upgrade-description">Mini tank orbits and auto-targets enemies. 50% slower fire rate, 50% more damage.</div>
                                <button class="upgrade-btn special-upgrade-btn" id="recruitBtn" onclick="purchaseUpgrade('recruit')">
                                    Hire (150 pts)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="game-over">
            <h1>Game Over</h1>
            <div id="final-score"></div>
            <button id="restart-btn">Play Again</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        const MAP_WIDTH = 2500;
        const MAP_HEIGHT = 2500;
        
        const camera = {
            x: 0,
            y: 0
        };
        
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
        
        const game = {
            score: 0,
            highScore: localStorage.getItem('tankio-highscore') || 0,
            level: 1,
            isGameOver: false,
            isPaused: false,
            difficulty: 1,
            lastDifficultyIncrease: 0,
            scoreForNextLevel: 500,
            currentBoss: null,
            bombCount: 0,
            maxBombs: 2
        };

        function addKillNotification(points) {
            const notification = document.createElement('div');
            notification.className = 'kill-notification';
            notification.textContent = `+${points}`;
            
            const killFeed = document.getElementById('kill-feed');
            killFeed.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        function triggerScreenEffect(color, duration = 200) {
            const effect = document.getElementById('screen-effect');
            effect.style.backgroundColor = color;
            effect.style.opacity = '0.5';
            
            setTimeout(() => {
                effect.style.opacity = '0';
            }, duration);
        }

        function showLevelComplete() {
            const banner = document.getElementById('level-complete-banner');
            banner.classList.add('show');
            
            setTimeout(() => {
                banner.classList.remove('show');
            }, 1000);
        }

        function updateBombCounter() {
            document.getElementById('bomb-counter').textContent = `Bombs: ${game.bombCount}/${game.maxBombs}`;
        }
        
        const items = [];
        const recruits = [];
        
        const upgrades = {
            fireRate: { level: 0, cost: 50, costIncrease: 25, maxLevel: 10 },
            damage: { level: 0, cost: 50, costIncrease: 30, maxLevel: 10 },
            health: { level: 0, cost: 75, costIncrease: 40, maxLevel: 8 },
            speed: { level: 0, cost: 40, costIncrease: 20, maxLevel: 10 },
            recruit: { level: 0, baseCost: 150, maxLevel: 6 }
        };

        function getRecruitCost() {
            return upgrades.recruit.baseCost * Math.pow(2, upgrades.recruit.level);
        }
        
        const player = {
            x: MAP_WIDTH / 2,
            y: MAP_HEIGHT / 2,
            radius: 25,
            angle: 0,
            speed: 3,
            baseSpeed: 3,
            health: 100,
            maxHealth: 100,
            baseMaxHealth: 100,
            color: '#00ff9d',
            barrelLength: 35,
            barrelWidth: 12,
            bulletDamage: 25,
            baseBulletDamage: 25,
            fireRate: 500,
            baseFireRate: 500,
            lastShot: 0
        };
        
        const keys = {};
        const mouse = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            rightDown: false
        };
        
        window.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;
            
            if (e.key.toLowerCase() === 'e') {
                useItem();
            }
            
            if (e.key === 'Escape') {
                if (!game.isGameOver) {
                    game.isPaused = !game.isPaused;
                    document.getElementById('pause-overlay').classList.toggle('show', game.isPaused);
                }
            }
        });
        
        window.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
        });
        
        canvas.addEventListener('mousemove', (e) => {
            mouse.x = e.clientX + camera.x;
            mouse.y = e.clientY + camera.y;
        });
        
        canvas.addEventListener('click', () => {
            if (!game.isGameOver && !game.isPaused) {
                const now = Date.now();
                if (now - player.lastShot >= player.fireRate) {
                    shootBullet();
                    player.lastShot = now;
                }
            }
        });
        
        canvas.addEventListener('mousedown', (e) => {
            if (e.button === 2) {
                mouse.rightDown = true;
                e.preventDefault();
            }
        });
        
        canvas.addEventListener('mouseup', (e) => {
            if (e.button === 2) {
                mouse.rightDown = false;
            }
        });
        
        canvas.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });
        
        const bullets = [];
        const recruitBullets = [];
        
        function shootBullet() {
            const angle = Math.atan2(mouse.y - player.y, mouse.x - player.x);
            bullets.push({
                x: player.x + Math.cos(angle) * (player.radius + player.barrelLength),
                y: player.y + Math.sin(angle) * (player.radius + player.barrelLength),
                vx: Math.cos(angle) * 8,
                vy: Math.sin(angle) * 8,
                radius: 6,
                damage: player.bulletDamage
            });
        }
        
        function shootRecruitBullet(recruit) {
            let nearestEnemy = null;
            let nearestDist = Infinity;
            
            for (const shape of shapes) {
                const dist = Math.sqrt(
                    (shape.x - recruit.x) ** 2 + 
                    (shape.y - recruit.y) ** 2
                );
                if (dist < nearestDist) {
                    nearestDist = dist;
                    nearestEnemy = shape;
                }
            }
            
            if (nearestEnemy) {
                const angle = Math.atan2(nearestEnemy.y - recruit.y, nearestEnemy.x - recruit.x);
                recruitBullets.push({
                    x: recruit.x + Math.cos(angle) * (recruit.radius + recruit.barrelLength),
                    y: recruit.y + Math.sin(angle) * (recruit.radius + recruit.barrelLength),
                    vx: Math.cos(angle) * 8,
                    vy: Math.sin(angle) * 8,
                    radius: 5,
                    damage: recruit.damage,
                    target: nearestEnemy
                });
            }
        }
        
        function createRecruit() {
            const index = recruits.length;
            const angleOffset = (Math.PI * 2 / 6) * index;
            
            recruits.push({
                radius: 15,
                barrelLength: 20,
                barrelWidth: 8,
                damage: player.baseBulletDamage * 1.5,
                fireRate: player.baseFireRate * 1.5,
                lastShot: 0,
                angleOffset: angleOffset,
                orbitRadius: 60,
                x: player.x,
                y: player.y
            });
        }
        
        function createItem() {
            const item = {
                x: Math.random() * (MAP_WIDTH - 100) + 50,
                y: Math.random() * (MAP_HEIGHT - 100) + 50,
                type: 'bomb',
                icon: 'ðŸ’£',
                name: 'Bomb',
                radius: 20
            };
            items.push(item);
        }
        
        function useItem() {
            if (game.bombCount <= 0 || game.isPaused || game.isGameOver) return;
            
            const destroyed = shapes.length;
            shapes.forEach(shape => {
                game.score += shape.points;
                addKillNotification(shape.points);
                if (shape.type === 'boss') {
                    game.currentBoss = null;
                    document.getElementById('boss-health-bar').classList.remove('show');
                }
            });
            shapes.length = 0;
            
            triggerScreenEffect('rgba(255, 85, 85, 0.5)', 300);
            
            game.bombCount--;
            updateBombCounter();
        }
        
        function drawItem(item) {
            ctx.save();
            ctx.translate(item.x, item.y);
            
            const pulse = Math.sin(Date.now() * 0.005) * 0.3 + 0.7;
            ctx.shadowBlur = 20 * pulse;
            ctx.shadowColor = '#ffc107';
            
            ctx.beginPath();
            ctx.arc(0, 0, item.radius, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(255, 193, 7, 0.2)';
            ctx.fill();
            ctx.strokeStyle = '#ffc107';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            ctx.shadowBlur = 0;
            ctx.font = '30px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(item.icon, 0, 0);
            
            ctx.restore();
        }
        
        const shapes = [];
        
        function createBoss() {
            if (game.currentBoss) return;

            let x, y;
            do {
                x = Math.random() * MAP_WIDTH;
                y = Math.random() * MAP_HEIGHT;
            } while (Math.sqrt((x - player.x) ** 2 + (y - player.y) ** 2) < 500);

            const healthMultiplier = 1 + (game.difficulty - 1) * 0.4;
            
            const boss = {
                x: x,
                y: y,
                type: 'boss',
                health: 1000 * healthMultiplier,
                maxHealth: 1000 * healthMultiplier,
                size: 60,
                speed: 0.8,
                color: '#8a2be2',
                rotation: 0,
                points: 200,
                damage: 2
            };
            
            shapes.push(boss);
            game.currentBoss = boss;
            document.getElementById('boss-health-bar').classList.add('show');
        }

        function createShape() {
            const types = ['square', 'triangle', 'pentagon'];
            const type = types[Math.floor(Math.random() * types.length)];
            
            let x, y;
            do {
                x = Math.random() * MAP_WIDTH;
                y = Math.random() * MAP_HEIGHT;
            } while (Math.sqrt((x - player.x) ** 2 + (y - player.y) ** 2) < 300);
            
            const healthMultiplier = 1 + (game.difficulty - 1) * 0.3;
            const speedMultiplier = 1 + (game.difficulty - 1) * 0.15;
            
            const baseHealth = type === 'square' ? 50 : type === 'triangle' ? 75 : 100;
            const baseSpeed = type === 'square' ? 1.5 : type === 'triangle' ? 2 : 1;
            
            const shape = {
                x: x,
                y: y,
                type: type,
                health: baseHealth * healthMultiplier,
                maxHealth: baseHealth * healthMultiplier,
                size: type === 'square' ? 30 : type === 'triangle' ? 35 : 40,
                speed: baseSpeed * speedMultiplier,
                color: type === 'square' ? '#ffcc00' : type === 'triangle' ? '#ff5555' : '#5599ff',
                rotation: 0,
                points: type === 'square' ? 10 : type === 'triangle' ? 25 : 50,
                damage: 0.5
            };
            
            shapes.push(shape);
        }
        
        function drawGrid() {
            ctx.strokeStyle = 'rgba(0, 255, 157, 0.08)';
            ctx.lineWidth = 1;
            
            const gridSize = 50;
            
            for (let x = 0; x < MAP_WIDTH; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, MAP_HEIGHT);
                ctx.stroke();
            }
            
            for (let y = 0; y < MAP_HEIGHT; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(MAP_WIDTH, y);
                ctx.stroke();
            }
            
            ctx.strokeStyle = 'rgba(0, 255, 157, 0.5)';
            ctx.lineWidth = 4;
            ctx.strokeRect(0, 0, MAP_WIDTH, MAP_HEIGHT);
        }
        
        function drawPlayer() {
            player.angle = Math.atan2(mouse.y - player.y, mouse.x - player.x);
            
            ctx.save();
            ctx.translate(player.x, player.y);
            ctx.rotate(player.angle);
            
            ctx.fillStyle = player.color;
            ctx.fillRect(0, -player.barrelWidth / 2, player.barrelLength, player.barrelWidth);
            
            ctx.restore();
            
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
            ctx.fillStyle = '#0a0e1a';
            ctx.fill();
            ctx.strokeStyle = player.color;
            ctx.lineWidth = 4;
            ctx.stroke();
            
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.radius - 8, 0, Math.PI * 2);
            ctx.fillStyle = player.color;
            ctx.globalAlpha = 0.3;
            ctx.fill();
            ctx.globalAlpha = 1;
        }
        
        function drawRecruit(recruit) {
            let nearestEnemy = null;
            let nearestDist = Infinity;
            
            for (const shape of shapes) {
                const dist = Math.sqrt(
                    (shape.x - recruit.x) ** 2 + 
                    (shape.y - recruit.y) ** 2
                );
                if (dist < nearestDist) {
                    nearestDist = dist;
                    nearestEnemy = shape;
                }
            }
            
            const angle = nearestEnemy ? 
                Math.atan2(nearestEnemy.y - recruit.y, nearestEnemy.x - recruit.x) : 0;
            
            ctx.save();
            ctx.translate(recruit.x, recruit.y);
            ctx.rotate(angle);
            
            ctx.fillStyle = '#ffd700';
            ctx.fillRect(0, -recruit.barrelWidth / 2, recruit.barrelLength, recruit.barrelWidth);
            
            ctx.restore();
            
            ctx.beginPath();
            ctx.arc(recruit.x, recruit.y, recruit.radius, 0, Math.PI * 2);
            ctx.fillStyle = '#0a0e1a';
            ctx.fill();
            ctx.strokeStyle = '#ffd700';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            ctx.beginPath();
            ctx.arc(recruit.x, recruit.y, recruit.radius - 5, 0, Math.PI * 2);
            ctx.fillStyle = '#ffd700';
            ctx.globalAlpha = 0.3;
            ctx.fill();
            ctx.globalAlpha = 1;
        }
        
        function updateRecruits() {
            const time = Date.now() * 0.001;
            
            for (let i = 0; i < recruits.length; i++) {
                const recruit = recruits[i];
                
                const angle = time + recruit.angleOffset;
                recruit.x = player.x + Math.cos(angle) * recruit.orbitRadius;
                recruit.y = player.y + Math.sin(angle) * recruit.orbitRadius;
                
                const now = Date.now();
                if (now - recruit.lastShot >= recruit.fireRate && shapes.length > 0) {
                    shootRecruitBullet(recruit);
                    recruit.lastShot = now;
                }
            }
        }
        
        function drawBullet(bullet) {
            ctx.beginPath();
            ctx.arc(bullet.x, bullet.y, bullet.radius, 0, Math.PI * 2);
            ctx.fillStyle = '#00ff9d';
            ctx.fill();
            ctx.strokeStyle = '#00d4aa';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            ctx.shadowBlur = 15;
            ctx.shadowColor = '#00ff9d';
            ctx.fill();
            ctx.shadowBlur = 0;
        }
        
        function drawRecruitBullet(bullet) {
            ctx.beginPath();
            ctx.arc(bullet.x, bullet.y, bullet.radius, 0, Math.PI * 2);
            ctx.fillStyle = '#ffd700';
            ctx.fill();
            ctx.strokeStyle = '#ffed4e';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            ctx.shadowBlur = 15;
            ctx.shadowColor = '#ffd700';
            ctx.fill();
            ctx.shadowBlur = 0;
        }
        
        function drawShape(shape) {
            ctx.save();
            ctx.translate(shape.x, shape.y);
            ctx.rotate(shape.rotation);
            
            ctx.fillStyle = shape.color;
            ctx.strokeStyle = '#0a0e1a';
            ctx.lineWidth = 3;
            
            if (shape.type === 'boss') {
                ctx.beginPath();
                for (let i = 0; i < 8; i++) {
                    const angle = (i * Math.PI * 2) / 8;
                    const x = Math.cos(angle) * shape.size;
                    const y = Math.sin(angle) * shape.size;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.closePath();
                
                ctx.shadowBlur = 20;
                ctx.shadowColor = shape.color;
                ctx.fill();
                ctx.shadowBlur = 0;
                ctx.lineWidth = 5;
                ctx.stroke();
            } else if (shape.type === 'square') {
                ctx.fillRect(-shape.size / 2, -shape.size / 2, shape.size, shape.size);
                ctx.strokeRect(-shape.size / 2, -shape.size / 2, shape.size, shape.size);
            } else if (shape.type === 'triangle') {
                ctx.beginPath();
                for (let i = 0; i < 3; i++) {
                    const angle = (i * Math.PI * 2) / 3 - Math.PI / 2;
                    const x = Math.cos(angle) * shape.size;
                    const y = Math.sin(angle) * shape.size;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            } else if (shape.type === 'pentagon') {
                ctx.beginPath();
                for (let i = 0; i < 5; i++) {
                    const angle = (i * Math.PI * 2) / 5 - Math.PI / 2;
                    const x = Math.cos(angle) * shape.size;
                    const y = Math.sin(angle) * shape.size;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            }
            
            if (shape.health < shape.maxHealth && shape.type !== 'boss') {
                const barWidth = shape.size * 1.5;
                const barHeight = 4;
                const barY = -shape.size - 10;
                
                ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
                ctx.fillRect(-barWidth / 2, barY, barWidth, barHeight);
                
                ctx.fillStyle = shape.color;
                const healthWidth = (shape.health / shape.maxHealth) * barWidth;
                ctx.fillRect(-barWidth / 2, barY, healthWidth, barHeight);
            }
            
            ctx.restore();
        }
        
        function updatePlayer() {
            let dx = 0;
            let dy = 0;
            
            if (keys['w']) dy -= 1;
            if (keys['s']) dy += 1;
            if (keys['a']) dx -= 1;
            if (keys['d']) dx += 1;
            
            if (dx !== 0 && dy !== 0) {
                dx *= Math.SQRT1_2;
                dy *= Math.SQRT1_2;
            }
            
            player.x += dx * player.speed;
            player.y += dy * player.speed;
            
            player.x = Math.max(player.radius, Math.min(MAP_WIDTH - player.radius, player.x));
            player.y = Math.max(player.radius, Math.min(MAP_HEIGHT - player.radius, player.y));
            
            camera.x = player.x - window.innerWidth / 2;
            camera.y = player.y - window.innerHeight / 2;
            
            camera.x = Math.max(0, Math.min(MAP_WIDTH - window.innerWidth, camera.x));
            camera.y = Math.max(0, Math.min(MAP_HEIGHT - window.innerHeight, camera.y));
        }
        
        function updateBullets() {
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.x += bullet.vx;
                bullet.y += bullet.vy;
                
                if (bullet.x < 0 || bullet.x > MAP_WIDTH || 
                    bullet.y < 0 || bullet.y > MAP_HEIGHT) {
                    bullets.splice(i, 1);
                }
            }
            
            for (let i = recruitBullets.length - 1; i >= 0; i--) {
                const bullet = recruitBullets[i];
                
                if (bullet.target && shapes.includes(bullet.target)) {
                    const dx = bullet.target.x - bullet.x;
                    const dy = bullet.target.y - bullet.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    if (dist > 0) {
                        const targetVx = (dx / dist) * 8;
                        const targetVy = (dy / dist) * 8;
                        
                        bullet.vx += (targetVx - bullet.vx) * 0.08;
                        bullet.vy += (targetVy - bullet.vy) * 0.08;
                    }
                }
                
                bullet.x += bullet.vx;
                bullet.y += bullet.vy;
                
                if (bullet.x < 0 || bullet.x > MAP_WIDTH || 
                    bullet.y < 0 || bullet.y > MAP_HEIGHT) {
                    recruitBullets.splice(i, 1);
                }
            }
        }
        
        function updateShapes() {
            for (let i = shapes.length - 1; i >= 0; i--) {
                const shape = shapes[i];
                
                const dx = player.x - shape.x;
                const dy = player.y - shape.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist > 0) {
                    shape.x += (dx / dist) * shape.speed;
                    shape.y += (dy / dist) * shape.speed;
                }
                
                shape.rotation += 0.02;
                
                for (let j = bullets.length - 1; j >= 0; j--) {
                    const bullet = bullets[j];
                    const bDist = Math.sqrt(
                        (bullet.x - shape.x) ** 2 + 
                        (bullet.y - shape.y) ** 2
                    );
                    
                    if (bDist < shape.size + bullet.radius) {
                        shape.health -= bullet.damage;
                        bullets.splice(j, 1);
                        
                        if (shape.health <= 0) {
                            game.score += shape.points;
                            
                            addKillNotification(shape.points);
                            triggerScreenEffect('rgba(255, 255, 255, 0.5)', 100);
                            
                            const newLevel = Math.floor(game.score / game.scoreForNextLevel) + 1;
                            if (newLevel > game.level) {
                                game.level = newLevel;
                                showLevelComplete();
                            }
                            
                            if (shape.type === 'boss') {
                                game.currentBoss = null;
                                document.getElementById('boss-health-bar').classList.remove('show');
                            }
                            
                            shapes.splice(i, 1);
                            break;
                        }
                    }
                }
                
                if (shapes[i]) {
                    for (let j = recruitBullets.length - 1; j >= 0; j--) {
                        const bullet = recruitBullets[j];
                        const bDist = Math.sqrt(
                            (bullet.x - shape.x) ** 2 + 
                            (bullet.y - shape.y) ** 2
                        );
                        
                        if (bDist < shape.size + bullet.radius) {
                            shape.health -= bullet.damage;
                            recruitBullets.splice(j, 1);
                            
                            if (shape.health <= 0) {
                                game.score += shape.points;
                                
                                addKillNotification(shape.points);
                                triggerScreenEffect('rgba(255, 255, 255, 0.5)', 100);
                                
                                const newLevel = Math.floor(game.score / game.scoreForNextLevel) + 1;
                                if (newLevel > game.level) {
                                    game.level = newLevel;
                                    showLevelComplete();
                                }
                                
                                if (shape.type === 'boss') {
                                    game.currentBoss = null;
                                    document.getElementById('boss-health-bar').classList.remove('show');
                                }
                                
                                shapes.splice(i, 1);
                                break;
                            }
                        }
                    }
                }
                
                if (shapes[i]) {
                    const pDist = Math.sqrt(
                        (player.x - shape.x) ** 2 + 
                        (player.y - shape.y) ** 2
                    );
                    
                    if (pDist < shape.size + player.radius) {
                        const damageAmount = shape.damage || 0.5;
                        player.health -= damageAmount;
                        
                        triggerScreenEffect('rgba(255, 0, 0, 0.4)', 150);
                        
                        if (player.health <= 0) {
                            player.health = 0;
                            gameOver();
                        }
                    }
                }
            }

            if (game.currentBoss) {
                const healthPercent = (game.currentBoss.health / game.currentBoss.maxHealth) * 100;
                document.getElementById('boss-health-fill').style.width = healthPercent + '%';
                document.getElementById('boss-health-text').textContent = 
                    Math.floor(game.currentBoss.health) + ' / ' + Math.floor(game.currentBoss.maxHealth);
            }
        }
        
        function updateItems() {
            for (let i = items.length - 1; i >= 0; i--) {
                const item = items[i];
                const dist = Math.sqrt(
                    (player.x - item.x) ** 2 + 
                    (player.y - item.y) ** 2
                );
                
                if (dist < player.radius + item.radius) {
                    if (game.bombCount < game.maxBombs) {
                        game.bombCount++;
                        updateBombCounter();
                        items.splice(i, 1);
                    }
                }
            }
        }
        
        function updateUI() {
            document.getElementById('score').textContent = game.score;
            document.getElementById('highScore').textContent = game.highScore;
            document.getElementById('level').textContent = game.level;
            
            const healthPercent = (player.health / player.maxHealth) * 100;
            document.getElementById('health-fill').style.width = healthPercent + '%';
            document.getElementById('health-text').textContent = 
                Math.floor(player.health) + ' / ' + Math.floor(player.maxHealth);
            
            updateUpgradeUI();
        }
        
        function updateUpgradeUI() {
            const fireRateUpgrade = upgrades.fireRate;
            document.getElementById('fireRateLevel').textContent = `Lv ${fireRateUpgrade.level}`;
            document.getElementById('fireRateBtn').textContent = 
                fireRateUpgrade.level >= fireRateUpgrade.maxLevel ? 'MAX' : `Buy (${fireRateUpgrade.cost} pts)`;
            document.getElementById('fireRateBtn').disabled = 
                game.score < fireRateUpgrade.cost || fireRateUpgrade.level >= fireRateUpgrade.maxLevel;
            
            const damageUpgrade = upgrades.damage;
            document.getElementById('damageLevel').textContent = `Lv ${damageUpgrade.level}`;
            document.getElementById('damageBtn').textContent = 
                damageUpgrade.level >= damageUpgrade.maxLevel ? 'MAX' : `Buy (${damageUpgrade.cost} pts)`;
            document.getElementById('damageBtn').disabled = 
                game.score < damageUpgrade.cost || damageUpgrade.level >= damageUpgrade.maxLevel;
            
            const healthUpgrade = upgrades.health;
            document.getElementById('healthLevel').textContent = `Lv ${healthUpgrade.level}`;
            document.getElementById('healthBtn').textContent = 
                healthUpgrade.level >= healthUpgrade.maxLevel ? 'MAX' : `Buy (${healthUpgrade.cost} pts)`;
            document.getElementById('healthBtn').disabled = 
                game.score < healthUpgrade.cost || healthUpgrade.level >= healthUpgrade.maxLevel;
            
            const speedUpgrade = upgrades.speed;
            document.getElementById('speedLevel').textContent = `Lv ${speedUpgrade.level}`;
            document.getElementById('speedBtn').textContent = 
                speedUpgrade.level >= speedUpgrade.maxLevel ? 'MAX' : `Buy (${speedUpgrade.cost} pts)`;
            document.getElementById('speedBtn').disabled = 
                game.score < speedUpgrade.cost || speedUpgrade.level >= speedUpgrade.maxLevel;
            
            const recruitUpgrade = upgrades.recruit;
            const recruitCost = getRecruitCost();
            document.getElementById('recruitLevel').textContent = `${recruitUpgrade.level} / ${recruitUpgrade.maxLevel}`;
            document.getElementById('recruitBtn').textContent = 
                recruitUpgrade.level >= recruitUpgrade.maxLevel ? 'MAX' : `Hire (${recruitCost} pts)`;
            document.getElementById('recruitBtn').disabled = 
                game.score < recruitCost || recruitUpgrade.level >= recruitUpgrade.maxLevel;
        }
        
        function purchaseUpgrade(type) {
            const upgrade = upgrades[type];
            const cost = type === 'recruit' ? getRecruitCost() : upgrade.cost;
            
            if (game.score >= cost && upgrade.level < upgrade.maxLevel) {
                game.score -= cost;
                upgrade.level++;
                
                if (type !== 'recruit') {
                    upgrade.cost += upgrade.costIncrease;
                }
                
                switch(type) {
                    case 'fireRate':
                        player.fireRate = player.baseFireRate * (1 - upgrade.level * 0.08);
                        break;
                    case 'damage':
                        player.bulletDamage = player.baseBulletDamage * (1 + upgrade.level * 0.25);
                        recruits.forEach(recruit => {
                            recruit.damage = player.baseBulletDamage * 1.5 * (1 + upgrade.level * 0.25);
                        });
                        break;
                    case 'health':
                        const oldMaxHealth = player.maxHealth;
                        player.maxHealth = player.baseMaxHealth * (1 + upgrade.level * 0.25);
                        player.health += (player.maxHealth - oldMaxHealth);
                        break;
                    case 'speed':
                        player.speed = player.baseSpeed * (1 + upgrade.level * 0.15);
                        break;
                    case 'recruit':
                        createRecruit();
                        break;
                }
                
                updateUI();
            }
        }
        
        function gameOver() {
            game.isGameOver = true;
            
            if (game.score > game.highScore) {
                game.highScore = game.score;
                localStorage.setItem('tankio-highscore', game.highScore);
            }
            
            document.getElementById('final-score').textContent = 
                `Final Score: ${game.score}` + 
                (game.score === game.highScore ? ' (NEW HIGH SCORE!)' : '');
            document.getElementById('game-over').classList.add('show');
        }
        
        document.getElementById('restart-btn').addEventListener('click', () => {
            game.score = 0;
            game.level = 1;
            game.isGameOver = false;
            game.isPaused = false;
            game.difficulty = 1;
            game.lastDifficultyIncrease = 0;
            game.currentBoss = null;
            game.bombCount = 0;
            
            upgrades.fireRate = { level: 0, cost: 50, costIncrease: 25, maxLevel: 10 };
            upgrades.damage = { level: 0, cost: 50, costIncrease: 30, maxLevel: 10 };
            upgrades.health = { level: 0, cost: 75, costIncrease: 40, maxLevel: 8 };
            upgrades.speed = { level: 0, cost: 40, costIncrease: 20, maxLevel: 10 };
            upgrades.recruit = { level: 0, baseCost: 150, maxLevel: 6 };
            
            player.health = player.baseMaxHealth;
            player.maxHealth = player.baseMaxHealth;
            player.x = MAP_WIDTH / 2;
            player.y = MAP_HEIGHT / 2;
            player.speed = player.baseSpeed;
            player.bulletDamage = player.baseBulletDamage;
            player.fireRate = player.baseFireRate;
            player.lastShot = 0;
            
            bullets.length = 0;
            recruitBullets.length = 0;
            shapes.length = 0;
            items.length = 0;
            recruits.length = 0;
            document.getElementById('game-over').classList.remove('show');
            document.getElementById('boss-health-bar').classList.remove('show');
            document.getElementById('kill-feed').innerHTML = '';
            updateUI();
            updateBombCounter();
        });
        
        let spawnInterval;
        
        function updateSpawnRate() {
            if (spawnInterval) clearInterval(spawnInterval);
            
            const baseSpawnRate = 2000;
            const spawnRate = Math.max(800, baseSpawnRate - (game.difficulty - 1) * 150);
            
            spawnInterval = setInterval(() => {
                if (!game.isGameOver && !game.isPaused) {
                    const maxShapes = 10 + game.difficulty * 2;
                    if (shapes.length < maxShapes) {
                        createShape();
                    }
                }
            }, spawnRate);
        }
        
        updateSpawnRate();
        
        setInterval(() => {
            if (!game.isGameOver && !game.isPaused && items.length < 3) {
                createItem();
            }
        }, 15000);

        setInterval(() => {
            if (!game.isGameOver && !game.isPaused && !game.currentBoss && game.level >= 2) {
                if (Math.random() < 0.25) {
                    createBoss();
                }
            }
        }, 20000);
        
        function gameLoop() {
            if (!game.isGameOver && !game.isPaused) {
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);
                ctx.translate(-camera.x, -camera.y);
                
                drawGrid();
                
                updatePlayer();
                updateBullets();
                updateShapes();
                updateItems();
                updateRecruits();
                
                if (mouse.rightDown) {
                    const now = Date.now();
                    if (now - player.lastShot >= player.fireRate) {
                        shootBullet();
                        player.lastShot = now;
                    }
                }
                
                drawPlayer();
                recruits.forEach(drawRecruit);
                bullets.forEach(drawBullet);
                recruitBullets.forEach(drawRecruitBullet);
                shapes.forEach(drawShape);
                items.forEach(drawItem);
                
                if (game.score >= game.lastDifficultyIncrease + 500) {
                    game.difficulty++;
                    game.lastDifficultyIncrease = game.score;
                    updateSpawnRate();
                }
                
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                
                updateUI();
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        updateBombCounter();
        gameLoop();
    </script>
</body>
</html>
